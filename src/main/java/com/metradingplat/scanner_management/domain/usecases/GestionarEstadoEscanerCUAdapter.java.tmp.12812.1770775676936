package com.metradingplat.scanner_management.domain.usecases;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import com.metradingplat.scanner_management.application.input.GestionarEstadoEscanerCUIntPort;
import com.metradingplat.scanner_management.application.output.FormateadorResultadosIntPort;
import com.metradingplat.scanner_management.application.output.GestionarEscanerGatewayIntPort;
import com.metradingplat.scanner_management.application.output.GestionarEstadoEscanerGatewayIntPort;
import com.metradingplat.scanner_management.domain.enums.EnumEstadoEscaner;
import com.metradingplat.scanner_management.domain.models.Escaner;
import com.metradingplat.scanner_management.domain.models.EstadoEscaner;
import com.metradingplat.scanner_management.domain.states.GestorEstadoEscaner;
import com.metradingplat.scanner_management.domain.states.escaner.ResultadoGestorEscaner;

import com.metradingplat.scanner_management.application.output.FuenteMensajesSignalProcessingIntPort;
import com.metradingplat.scanner_management.application.output.NotificacionKafkaProducerIntPort;

@RequiredArgsConstructor
@Slf4j
public class GestionarEstadoEscanerCUAdapter implements GestionarEstadoEscanerCUIntPort {

    private final GestionarEstadoEscanerGatewayIntPort objGestionarEstadoEscanerGatewayIntPort;
    private final GestionarEscanerGatewayIntPort objGestionarEscanerGatewayIntPort;
    private final FormateadorResultadosIntPort objFormateadorResultados;
    private final FuenteMensajesSignalProcessingIntPort objFuenteMensajesSignalProcessing;
    private final NotificacionKafkaProducerIntPort objNotificacionProducer;

    @Override
    public EstadoEscaner iniciarEscaner(Long id) {
        log.info("[USE-CASE] iniciarEscaner - id={}", id);
        Escaner escaner = validarEscanerExistente(id);

        if (escaner.getFiltros() == null || escaner.getFiltros().isEmpty()) {
            log.warn("[USE-CASE] iniciarEscaner - id={} sin filtros, rechazando", id);
            this.objFormateadorResultados.errorReglaNegocioViolada("validation.scanner.filters.required");
        }

        String estadoAnterior = escaner.getObjEstado().getEnumEstadoEscaner().name();
        log.info("[USE-CASE] iniciarEscaner - cambiando estado a INICIADO, id={}", id);
        EstadoEscaner estado = cambiarEstado(escaner, EnumEstadoEscaner.INICIADO);
        escaner.setObjEstado(estado);
        log.info("[USE-CASE] iniciarEscaner - estado cambiado OK, notificando signal-processing, id={}", id);
        this.objFuenteMensajesSignalProcessing.notificarEscanerIniciado(escaner);
        log.info("[USE-CASE] iniciarEscaner - publicando notificacion Kafka, id={}", id);
        publicarNotificacionCambioEstado(id, "INICIADO", "Escaner iniciado por usuario");
        publicarEventoEstado(id, escaner.getNombre(), estadoAnterior, "INICIADO", "Iniciado por usuario");
        log.info("[USE-CASE] iniciarEscaner - COMPLETADO, id={}, nuevoEstado={}", id, estado.getEnumEstadoEscaner());
        return estado;
    }

    @Override
    public EstadoEscaner detenerEscaner(Long id) {
        log.info("[USE-CASE] detenerEscaner - id={}", id);
        Escaner escaner = validarEscanerExistente(id);
        String estadoAnterior = escaner.getObjEstado().getEnumEstadoEscaner().name();
        EstadoEscaner estado = cambiarEstado(escaner, EnumEstadoEscaner.DETENIDO);
        log.info("[USE-CASE] detenerEscaner - estado cambiado OK, notificando signal-processing, id={}", id);
        this.objFuenteMensajesSignalProcessing.notificarEscanerDetenido(id);
        log.info("[USE-CASE] detenerEscaner - publicando notificacion Kafka, id={}", id);
        publicarNotificacionCambioEstado(id, "DETENIDO", "Escaner detenido por usuario");
        publicarEventoEstado(id, escaner.getNombre(), estadoAnterior, "DETENIDO", "Detenido por usuario");
        log.info("[USE-CASE] detenerEscaner - COMPLETADO, id={}, nuevoEstado={}", id, estado.getEnumEstadoEscaner());
        return estado;
    }

    @Override
    public EstadoEscaner detenerEscanerInterno(Long id) {
        log.info("[USE-CASE] detenerEscanerInterno (desde Kafka) - id={}", id);
        Escaner escaner = validarEscanerExistente(id);
        EstadoEscaner estado = cambiarEstado(escaner, EnumEstadoEscaner.DETENIDO);
        // No notificar a signal-processing (ya lo sabe, el evento viene de alli)
        // Pero S√ç notificar a los clientes SSE para que actualicen la UI
        log.info("[USE-CASE] detenerEscanerInterno - publicando notificacion Kafka, id={}", id);
        publicarNotificacionCambioEstado(id, "DETENIDO", "Escaner UNA_VEZ completado");
        publicarEventoEstado(id, escaner.getNombre(), "INICIADO", "DETENIDO", "ESCANER_UNA_VEZ completado");
        log.info("[USE-CASE] detenerEscanerInterno - COMPLETADO, id={}", id);
        return estado;
    }

    @Override
    public EstadoEscaner archivarEscaner(Long id) {
        log.info("[USE-CASE] archivarEscaner - id={}", id);
        return cambiarEstado(validarEscanerExistente(id), EnumEstadoEscaner.ARCHIVADO);
    }

    @Override
    public EstadoEscaner desarchivarEscaner(Long id) {
        log.info("[USE-CASE] desarchivarEscaner - id={}", id);
        return cambiarEstado(validarEscanerExistente(id), EnumEstadoEscaner.DESARCHIVADO);
    }

    private Escaner validarEscanerExistente(Long id) {
        if (!this.objGestionarEscanerGatewayIntPort.existeEscanerPorId(id)) {
            log.error("[USE-CASE] Escaner no existe: id={}", id);
            this.objFormateadorResultados.errorEntidadNoExiste("validation.scanner.id.notFound", id);
        }
        return this.objGestionarEscanerGatewayIntPort.obtenerEscanerPorId(id);
    }

    private EstadoEscaner cambiarEstado(Escaner escaner, EnumEstadoEscaner nuevoEstado) {
        EnumEstadoEscaner estadoActual = escaner.getObjEstado().getEnumEstadoEscaner();
        log.info("[USE-CASE] cambiarEstado: id={}, estadoActual={}, nuevoEstado={}",
                escaner.getIdEscaner(), estadoActual, nuevoEstado);
        GestorEstadoEscaner gestorEstado = new GestorEstadoEscaner(estadoActual);
        ResultadoGestorEscaner resultado = gestorEstado.cambiarEstado(nuevoEstado);

        if (!resultado.cambioPermitido()) {
            log.error("[USE-CASE] Cambio de estado denegado: id={}, mensaje={}",
                    escaner.getIdEscaner(), resultado.mensaje());
            this.objFormateadorResultados.errorEstadoDenegado(resultado.mensaje());
        }

        return this.objGestionarEstadoEscanerGatewayIntPort.cambiarEstadoDeEscaner(escaner, nuevoEstado);
    }

    private void publicarNotificacionCambioEstado(Long idEscaner, String nuevoEstado, String mensaje) {
        if (this.objNotificacionProducer != null) {
            log.info("[USE-CASE] Publicando notificacion Kafka: idEscaner={}, tipo=SCANNER_STATE, estado={}",
                    idEscaner, nuevoEstado);
            this.objNotificacionProducer.publicarNotificacion(
                idEscaner,
                "SCANNER_STATE",
                "INFO",
                mensaje,
                "SCANNER"
            );
            log.info("[USE-CASE] Notificacion Kafka publicada OK: idEscaner={}", idEscaner);
        } else {
            log.warn("[USE-CASE] NotificacionProducer es null, no se puede publicar notificacion");
        }
    }

    private void publicarEventoEstado(Long idEscaner, String nombreEscaner, String estadoAnterior, String estadoNuevo, String razon) {
        if (this.objNotificacionProducer != null) {
            this.objNotificacionProducer.publicarCambioEstadoEscaner(idEscaner, nombreEscaner, estadoAnterior, estadoNuevo, razon);
        }
    }
}
